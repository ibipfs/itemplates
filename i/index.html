<!DOCTYPE html>
<html>
<head>
  <title>i: Getting into IPFS and Opening for Evolving</title>
  <link rel="icon" href="/ipfs/QmRHWAFLWrwrNUdkZTaPcgusD6rhesTizNBF8f2ayLcd1G/i/fav.png">
  <link rel="stylesheet" href="/ipfs/QmRHWAFLWrwrNUdkZTaPcgusD6rhesTizNBF8f2ayLcd1G/i/codemirror.css">
  <style>
    .CodeMirror {border-top: 1px solid #eee; border-bottom: 1px solid #eee; line-height: 1.3; height: 96%; width: 100%}
    .CodeMirror-linenumbers { padding: 0 8px; }
  </style>
</head>
<body>
	<article id="src"></article>
  <button onclick="iEvolve()">iEvolve</button>
  <script type="text/javascript" src="/ipfs/Qmbod38fEfMtF8udMvqDww7TgBoSEtrnWnj9cahtPYHeC7/ibipfs.js"></script>
  <script type="text/javascript" src="/ipfs/QmRHWAFLWrwrNUdkZTaPcgusD6rhesTizNBF8f2ayLcd1G/i/codemirror.js"></script>
  <script type="text/javascript">
    let ibipfs

    let editor

    const iEvolve = () => {
      if (!ibipfs || !editor) {
        alert('Oops! Not ready yet, please try after a while. :)')

        return
      }

      ibipfs
      .add(ibipfs.Ipfs.Buffer.from(editor.getValue()))
      .then(res => {
        let decision = confirm('Evolved! Would you like to have a look? :)')

        if (decision) {
          let url = window.location.href

          url = url.slice(0, url.lastIndexOf('/ipfs/')) + '/ipfs/' + res[0].hash

          window.open(url)
        } else {
          alert('Evolved @ /ipfs/' + res[0].hash)
        }
      })
      .catch(err => alert('Oops! Error: ' + err))
    }

  	window.onload = () => {
  		window.addEventListener('ibipfs', (e) => {
  			ibipfs = window.ibipfs

  			ibipfs
  			.id()
  			.then(identity => {
  				let publisherMeta = document.createElement('meta')

  				publisherMeta.setAttribute('charset', 'utf-8')
  				publisherMeta.setAttribute('name', 'publisher')
  				publisherMeta.setAttribute('content', identity.id)

  				document.head.prepend(publisherMeta)
  			})
  			.catch(err => console.log('Error: ' + err))

        ibipfs
  			.add(ibipfs.Ipfs.Buffer.from(document.documentElement.innerHTML))
  			.then(res => {
          ibipfs
          .cat(res[0].hash)
          .then(buf => {          
            editor = CodeMirror(document.getElementById('src'), {
                value: buf.toString(),
                lineNumbers: true,
                mode: "javascript",
                autoCloseBrackets: true,
                matchBrackets: true,
                showCursorWhenSelecting: true,
                tabSize: 2
              })
          })
  			})
  			.catch(err => console.log('Error: ' + err))
  		})
  	}
  </script>
</body>
</html>